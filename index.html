const HELIUS_RPC = 'https://mainnet.helius-rpc.com/?api-key=1a333300-f919-4d0e-ae4c-31b993844ba8';

async function startScan() {
    const mint = document.getElementById('tokenAddr').value.trim();
    if(!mint) return alert("ENTER MINT ADDRESS, ANON.");

    // Reveal UI
    document.getElementById('results').style.opacity = '1';
    
    try {
        // 1. EMBED TRADINGVIEW (Fastest Charting)
        new TradingView.widget({
            "autosize": true,
            "symbol": `DEXSCREENER:${mint}`, // Dexscreener provider for newest pairs
            "interval": "1",
            "theme": "dark",
            "container_id": "tradingview_widget",
            "library_path": "https://s3.tradingview.com/tv.js"
        });

        // 2. FETCH TOKEN METADATA & DEPLOYER (DAS API)
        const assetResponse = await fetch(HELIUS_RPC, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                jsonrpc: '2.0', id: 'dedu-scan',
                method: 'getAsset',
                params: { id: mint }
            })
        });
        const assetData = await assetResponse.json();
        const deployerWallet = assetData.result.authorities[0]?.address;

        // 3. FETCH TOP 20 HOLDERS (Live Data)
        const holderResponse = await fetch(HELIUS_RPC, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                jsonrpc: '2.0', id: 'dedu-scan',
                method: 'getTokenLargestAccounts',
                params: [mint]
            })
        });
        const holders = await holderResponse.json();
        renderVolumeBars(holders.result.value);

        // 4. SCAN DEPLOYER HISTORY (Check for serial launches)
        const sigResponse = await fetch(HELIUS_RPC, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                jsonrpc: '2.0', id: 'dedu-scan',
                method: 'getSignaturesForAddress',
                params: [deployerWallet, { limit: 50 }]
            })
        });
        const sigs = await sigResponse.json();
        
        // Logical Analysis
        const tokensMade = sigs.result.length > 40 ? "50+" : sigs.result.length;
        document.getElementById('tokensMade').innerText = `${tokensMade} TXS`;
        document.getElementById('bondedCount').innerText = assetData.result.supply.basis_points > 0 ? "ACTIVE" : "BONDED";

        generateAISuggestion(holders.result.value, tokensMade);

    } catch (err) {
        console.error("SCAN_ERROR:", err);
        document.getElementById('aiSuggestion').innerText = "ERROR: NODE CONGESTION OR INVALID MINT.";
    }
}

function renderVolumeBars(holders) {
    const tracker = document.getElementById('volumeTracker');
    tracker.innerHTML = '';
    holders.slice(0, 20).forEach(h => {
        const bar = document.createElement('div');
        const percentage = (h.uiAmount / holders[0].uiAmount) * 100;
        bar.className = 'w-2 bg-[#6b21a8] hover:bg-[#00ffa3] transition-all duration-300';
        bar.style.height = `${Math.max(percentage, 10)}%`;
        tracker.appendChild(bar);
    });
    document.getElementById('top20Action').innerText = "TOP 20: DISTRIBUTION ANALYZED";
}

function generateAISuggestion(holders, txCount) {
    const top1 = holders[0].share || 0;
    let advice = "";
    
    if (top1 > 15) advice = "CRITICAL: Top holder owns >15%. High dump potential. üö®";
    else if (txCount > 40) advice = "WARNING: Highly active deployer. Check for 'churning' patterns. ‚ö†Ô∏è";
    else advice = "BULLISH: Clean holder distribution & fresh deployer. Looks SAFU. ‚úÖ";

    document.getElementById('aiSuggestion').innerText = `[SYSTEM_ADVICE]: ${advice}`;
}
