<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DEDU | PROTOCOL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --neon: #00ffa3; --bg: #050505; --panel: #0a0a0a; }
        body { background-color: var(--bg); color: #e5e5e5; font-family: 'Space+Mono', monospace; }
        .terminal-box { border: 1px solid #333; background: var(--panel); position: relative; }
        .glitch-text { text-shadow: 2px 0 #fff, -2px 0 #00ffa3; }
        .btn-scan { background: var(--neon); color: black; font-weight: 900; text-transform: uppercase; transition: all 0.2s; }
        .btn-scan:hover { background: white; box-shadow: 0 0 15px var(--neon); }
        .audit-link { border: 1px solid #333; color: #888; padding: 8px; text-align: center; font-size: 10px; text-transform: uppercase; transition: 0.2s; cursor: pointer; display: block; text-decoration: none; }
        .audit-link:hover { border-color: var(--neon); color: var(--neon); background: #00ffa311; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center mb-8 gap-6">
        <div class="flex items-center gap-4">
            <div class="w-12 h-12 border-2 border-[#00ffa3] flex items-center justify-center text-2xl font-black text-[#00ffa3] bg-black">D</div>
            <div>
                <h1 class="text-xl font-black italic tracking-tighter text-white">DEDU PROTOCOL</h1>
                <p class="text-[9px] text-gray-500 tracking-[0.3em]">MULTI TIMEFRAME PEAK ANALYSIS</p>
            </div>
        </div>
        <div class="flex w-full md:w-auto gap-2">
            <input id="tokenAddr" type="text" placeholder="ENTER TOKEN ADDRESS..." class="bg-black border border-[#333] p-3 text-xs flex-grow md:w-80 text-[#00ffa3] outline-none focus:border-[#00ffa3] font-bold">
            <button onclick="ignite()" class="btn-scan px-6 py-3 text-xs italic">RUN SCAN</button>
        </div>
    </div>

    <div id="ui" class="max-w-7xl mx-auto hidden grid grid-cols-1 lg:grid-cols-12 gap-6">
        
        <div class="lg:col-span-8 h-[600px] terminal-box border-t-4 border-t-[#00ffa3]">
            <iframe id="market-chart" class="w-full h-full opacity-90" src=""></iframe>
        </div>

        <div class="lg:col-span-4 space-y-4">
            
            <div id="athPanel" class="terminal-box p-6 border-l-8 border-l-gray-700 transition-colors duration-500">
                <p class="text-[9px] text-gray-500 font-bold tracking-widest mb-2">// GLOBAL_PEAK_DELTA</p>
                <div id="deltaDisplay" class="text-6xl font-black italic tracking-tighter text-white mb-2">0.00%</div>
                
                <div class="grid grid-cols-2 gap-4 text-[10px] uppercase font-bold text-gray-400 border-t border-gray-800 pt-4">
                    <div>
                        <span class="block text-gray-600">TRUE PEAK (ATH)</span>
                        <span id="athMcap" class="text-[#00ffa3] text-lg">--</span>
                    </div>
                    <div>
                        <span class="block text-gray-600">LIVE MCAP</span>
                        <span id="liveMcap" class="text-white text-lg">--</span>
                    </div>
                </div>

                <div class="mt-4 pt-4 border-t border-gray-800">
                    <div id="cmdLabel" class="text-2xl font-black italic uppercase text-white">INITIALIZING</div>
                    <p id="cmdNote" class="text-xs text-gray-500 italic mt-1">Comparing 1h, 6h, and 24h peaks...</p>
                </div>
            </div>

            <div class="terminal-box p-6">
                <p class="text-[9px] text-gray-500 font-bold tracking-widest mb-4">// DEPLOYER_DEEP_SEARCH</p>
                <p class="text-[10px] text-gray-600 mb-4 italic">
                    âš  AUTOMATED HISTORY API IS RESTRICTED.<br>
                    USE THESE DIRECT LINKS TO CHECK DEV HISTORY:
                </p>
                
                <div class="grid grid-cols-2 gap-2">
                    <a id="linkGmgn" target="_blank" class="audit-link">GMGN.AI CHECK</a>
                    <a id="linkBullx" target="_blank" class="audit-link">BULLX NEO</a>
                    <a id="linkSolscan" target="_blank" class="audit-link">SOLSCAN ACCT</a>
                    <a id="linkRugcheck" target="_blank" class="audit-link">RUGCHECK.XYZ</a>
                </div>

                <div class="mt-4 pt-4 border-t border-gray-800 flex justify-between items-center">
                    <span class="text-[10px] font-bold text-gray-500">LIQUIDITY STATUS</span>
                    <span id="liqStatus" class="text-xs font-black text-white italic">SCANNING...</span>
                </div>
            </div>

        </div>
    </div>

    <script>
        let globalPeak = 0;

        function formatVal(v) {
            if (v >= 1000000) return (v / 1000000).toFixed(2) + "M";
            if (v >= 1000) return (v / 1000).toFixed(1) + "K";
            return v.toFixed(0);
        }

        async function ignite() {
            const mint = document.getElementById('tokenAddr').value.trim();
            if(!mint) return;

            // UI Setup
            document.getElementById('ui').classList.remove('hidden');
            document.getElementById('market-chart').src = `https://dexscreener.com/solana/${mint}?embed=1&theme=dark&trades=0&info=0`;

            // Setup External Links
            document.getElementById('linkGmgn').href = `https://gmgn.ai/sol/token/${mint}`;
            document.getElementById('linkBullx').href = `https://bullx.io/terminal?chainId=1399811149&address=${mint}`;
            document.getElementById('linkSolscan').href = `https://solscan.io/token/${mint}`;
            document.getElementById('linkRugcheck').href = `https://rugcheck.xyz/tokens/${mint}`;

            // Start Analysis Loop
            globalPeak = 0;
            analyze(mint);
            setInterval(() => analyze(mint), 3000);
        }

        async function analyze(mint) {
            try {
                const res = await fetch(`https://api.dexscreener.com/latest/dex/tokens/${mint}`);
                const data = await res.json();
                const pair = data.pairs[0];
                const liveMcap = pair.fdv;
                
                // --- MULTI-TIMEFRAME PEAK RECOVERY ---
                // We calculate what the price WAS based on the change percentage for h1, h6, and h24.
                // Formula: OriginalPrice = CurrentPrice / (1 + (Change% / 100))
                
                const changes = pair.priceChange;
                
                // 1. Calculate Implied Highs
                const impliedH1 = changes.h1 ? liveMcap / (1 + (changes.h1 / 100)) : 0;
                const impliedH6 = changes.h6 ? liveMcap / (1 + (changes.h6 / 100)) : 0;
                const impliedH24 = changes.h24 ? liveMcap / (1 + (changes.h24 / 100)) : 0;
                
                // 2. Find the Absolute Maximum among implied highs and current live price
                // We assume the peak is at least the highest of these reconstructed values
                let calculatedPeak = Math.max(liveMcap, impliedH1, impliedH6, impliedH24);

                // 3. Persistent Storage (Never let ATH drop during session)
                if (calculatedPeak > globalPeak) globalPeak = calculatedPeak;

                // --- UPDATE UI ---
                document.getElementById('athMcap').innerText = "$" + formatVal(globalPeak);
                document.getElementById('liveMcap').innerText = "$" + formatVal(liveMcap);

                // Calculate Delta from the RECONSTRUCTED Global Peak
                const delta = ((liveMcap - globalPeak) / globalPeak) * 100;
                
                document.getElementById('deltaDisplay').innerText = delta.toFixed(2) + "%";
                
                updateDecisionMatrix(delta);
                updateLiquidityStatus(pair);

            } catch (e) { console.error("Stream Error", e); }
        }

        function updateDecisionMatrix(delta) {
            const panel = document.getElementById('athPanel');
            const cmd = document.getElementById('cmdLabel');
            const note = document.getElementById('cmdNote');
            const disp = document.getElementById('deltaDisplay');

            // EXACT TRADING ZONES
            if (delta >= -5) {
                // Near ATH (0% to -5%)
                panel.style.borderLeftColor = "#fbbf24"; // Yellow
                disp.style.color = "#fbbf24";
                cmd.innerText = "WAIT / ATH";
                cmd.className = "text-2xl font-black italic text-yellow-500";
                note.innerText = "Price is at peak. Do not buy.";
            } 
            else if (delta <= -80) {
                // Dead Zone (-80% to -99%)
                panel.style.borderLeftColor = "#ef4444"; // Red
                disp.style.color = "#ef4444";
                cmd.innerText = "RUGGED / DEAD";
                cmd.className = "text-2xl font-black italic text-red-500";
                note.innerText = "Loss > 80%. High probability of abandonment.";
            }
            else if (delta <= -30 && delta >= -60) {
                // Goldilocks Zone (-30% to -60%)
                panel.style.borderLeftColor = "#00ffa3"; // Green
                disp.style.color = "#00ffa3";
                cmd.innerText = "ENTRY ZONE";
                cmd.className = "text-2xl font-black italic text-[#00ffa3]";
                note.innerText = "Optimal dip retracement. Check Liquidity.";
            }
            else {
                // No Man's Land
                panel.style.borderLeftColor = "#6b7280"; // Gray
                disp.style.color = "#9ca3af";
                cmd.innerText = "OBSERVE";
                cmd.className = "text-2xl font-black italic text-gray-400";
                note.innerText = "Price is moving. Wait for signal.";
            }
        }

        function updateLiquidityStatus(pair) {
            const el = document.getElementById('liqStatus');
            const isRaydium = pair.dexId === 'raydium';
            const isPump = pair.dexId === 'pump'; // pump.fun usually labeled 'pump' or custom

            if (isRaydium) {
                el.innerText = "GRADUATED (RAYDIUM)";
                el.className = "text-xs font-black italic text-[#00ffa3]";
            } else if (pair.labels && pair.labels.includes("pump")) {
                el.innerText = "BONDING CURVE (PUMP)";
                el.className = "text-xs font-black italic text-orange-500";
            } else {
                el.innerText = pair.dexId.toUpperCase();
                el.className = "text-xs font-black italic text-blue-500";
            }
        }
    </script>
</body>
</html>
